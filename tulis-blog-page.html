<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tulis Blog - Piilancer: Ruang Kreasi Pelajar</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Pacifico (for logo) and Montserrat (for headings) -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom font for a modern look */
        body {
            font-family: "Inter", sans-serif;
        }
        /* Custom blue color for Tailwind */
        .bg-custom-blue {
            background-color: #8aceff;
        }
        .text-custom-blue {
            color: #8aceff;
        }
        .hover\\:bg-custom-blue-light:hover {
            background-color: #e0f2ff; /* A lighter shade for hover effects */
        }
        .hover\\:text-custom-blue-dark:hover {
            color: #007bff; /* A slightly darker blue for hover text */
        }
        .focus\\:ring-custom-blue-focus:focus {
            --tw-ring-color: #8aceff;
        }
        /* Style for Piilancer logo font */
        .piilancer-logo {
            font-family: 'Pacifico', cursive;
            font-size: 2rem; /* Reduced from 2.5rem */
            line-height: 1;
        }
        /* Style for Hero Section Heading font */
        .hero-heading-font {
            font-family: 'Montserrat', sans-serif;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 400px;
            text-align: center;
            transform: translateY(-20px);
            opacity: 0;
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
    <div class="min-h-screen flex flex-col">
        <!-- Header Section (Consistent with Homepage) -->
        <header class="bg-white shadow-md py-4">
            <div class="container mx-auto px-4 flex justify-between items-center">
                <a href="homepage-template.html" class="piilancer-logo text-blue-600 rounded-lg p-2 hover:bg-blue-50 transition duration-300">Piilancer</a>
                <nav class="hidden md:flex space-x-6 items-center">
                    <a href="baca-blog-page.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300 rounded-lg px-3 py-2 hover:bg-gray-100">Baca Blog</a>
                    <a href="tulis-blog-page.html" class="text-blue-600 font-bold transition duration-300 rounded-lg px-3 py-2 bg-gray-100">Tulis Blog</a>
                    <a href="kedai-pelajar-page.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300 rounded-lg px-3 py-2 hover:bg-gray-100">Kedai Pelajar</a>
                    <a href="tentang-page.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300 rounded-lg px-3 py-2 hover:bg-gray-100">Tentang</a>

                    <!-- Profile Picture / Auth Menu -->
                    <div class="relative ml-4">
                        <button id="profile-menu-button" class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-200 text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                            <img id="profile-pic" src="https://placehold.co/40x40/cbd5e1/4a5568?text=U" alt="User Profile" class="rounded-full w-full h-full object-cover hidden">
                            <svg id="profile-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M12 4a4 4 0 100 8 4 4 0 000-8zm-2 9a4 4 0 00-4 4v1a2 2 0 002 2h8a2 2 0 002-2v-1a4 4 0 00-4-4h-4z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="profile-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                            <a href="auth-page.html" id="login-signup-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Login / Daftar</a>
                            <a href="#" id="my-profile-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hidden">Profil Saya</a>
                            <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 hidden">Logout</button>
                        </div>
                    </div>
                </nav>
                <!-- Mobile Menu Button (Hamburger) -->
                <button class="md:hidden text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content - Write Blog Post -->
        <main class="flex-grow py-16 bg-gray-100">
            <div class="container mx-auto px-4 max-w-3xl bg-white p-8 rounded-xl shadow-lg border border-gray-200">
                <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-8 text-gray-900 hero-heading-font">Tulis Postingan Blog Baru</h1>

                <!-- Firebase Status Message Area -->
                <div id="firebase-status" class="mb-4 p-3 rounded-lg text-sm text-center bg-blue-50 text-blue-800 border border-blue-200 hidden">
                    <!-- Status will be displayed here by JavaScript -->
                </div>

                <!-- Message Display Area -->
                <div id="message-area" class="mb-6"></div>

                <form id="blog-post-form" class="space-y-6">
                    <div>
                        <label for="post-title" class="block text-lg font-medium text-gray-700 mb-2">Judul Postingan</label>
                        <input type="text" id="post-title" name="post-title" placeholder="Masukkan judul postingan Anda..."
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-gray-800">
                        <p id="title-error" class="text-red-500 text-sm mt-1 hidden">Judul postingan tidak boleh kosong.</p>
                    </div>

                    <div>
                        <label for="post-author" class="block text-lg font-medium text-gray-700 mb-2">Nama Penulis</label>
                        <input type="text" id="post-author" name="post-author" placeholder="Nama Anda (Opsional)" readonly
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed text-gray-800">
                    </div>

                    <div>
                        <label for="post-category" class="block text-lg font-medium text-gray-700 mb-2">Kategori</label>
                        <select id="post-category" name="post-category"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-white text-gray-800">
                            <option value="">Pilih Kategori</option>
                            <option value="pendidikan">Pendidikan</option>
                            <option value="kreativitas">Kreativitas</option>
                            <option value="inspirasi">Inspirasi</option>
                            <option value="tips">Tips & Trik</option>
                            <option value="lain-lain">Lain-lain</option>
                        </select>
                    </div>

                    <div>
                        <label for="post-content" class="block text-lg font-medium text-gray-700 mb-2">Isi Postingan</label>
                        <textarea id="post-content" name="post-content" rows="15" placeholder="Mulai tulis cerita, ide, atau pengetahuan Anda di sini..."
                                  class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-gray-800 resize-y"></textarea>
                        <p id="content-error" class="text-red-500 text-sm mt-1 hidden">Isi postingan tidak boleh kosong.</p>
                    </div>

                    <div>
                        <label for="post-image-url" class="block text-lg font-medium text-gray-700 mb-2">URL Gambar Postingan (Opsional)</label>
                        <input type="url" id="post-image-url" name="post-image-url" placeholder="Paste URL gambar di sini, atau biarkan kosong untuk gambar default"
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-gray-800">
                    </div>

                    <div class="text-center">
                        <button type="submit" id="publish-button" class="bg-blue-600 text-white hover:bg-blue-700 px-8 py-4 rounded-full font-semibold text-lg shadow-xl transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Publikasikan Postingan
                        </button>
                    </div>
                </form>
            </div>
        </main>

        <!-- Login/Signup Modal -->
        <div id="auth-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Anda Perlu Login atau Daftar</h2>
                <p class="text-gray-700 mb-6">Untuk menulis postingan blog, silakan masuk ke akun Anda atau daftar akun baru.</p>
                <button id="go-to-auth-button" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-3 rounded-full font-semibold shadow-md transition duration-300 transform hover:scale-105">
                    Login / Daftar Sekarang
                </button>
            </div>
        </div>

        <!-- Footer Section (Consistent with Homepage) -->
        <footer class="bg-gray-800 text-white py-8">
            <div class="container mx-auto px-4 text-center">
                <p class="text-gray-400">&copy; 2025 Piilancer. All rights reserved.</p>
                <div class="flex justify-center space-x-6 mt-4">
                    <a href="https://instagram.com/piilancer" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition duration-300 rounded-lg p-2 hover:bg-gray-700 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2.411a.75.75 0 01.597.953l-1.39 4.364 7.26 2.253a.75.75 0 01.385 1.487l-7.26 2.253 1.39 4.364a.75.75 0 01-1.35.43l-1.39-4.364-7.26 2.253a.75.75 0 01-.385-1.487l7.26-2.253-1.39-4.364a.75.75 0 01.75-.43zM12 0a12 12 0 100 24 12 12 0 000-24z" clip-rule="evenodd" />
                        </svg>
                        <span>@piilancer</span>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition duration-300 rounded-lg p-2 hover:bg-gray-700">Kebijakan Privasi</a>
                    <a href="#" class="text-gray-400 hover:text-white transition duration-300 rounded-lg p-2 hover:bg-gray-700">Ketentuan Layanan</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- START LOCAL DEVELOPMENT CONFIG (UNCOMMENT AND FILL FOR LOCAL TESTING) ---
        /*
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            // measurementId: "YOUR_MEASUREMENT_ID" // Optional
        };
        const appId = "YOUR_PROJECT_ID"; // Or any unique ID for your local testing
        */
        // --- END LOCAL DEVELOPMENT CONFIG ---

        // Firebase configuration (provided by Canvas environment, or use local config above)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fallback for local testing

        let app;
        let db;
        let auth;
        let currentUser = null; // To store the authenticated user object

        // Get elements for header profile menu
        const profileMenuButton = document.getElementById('profile-menu-button');
        const profileMenu = document.getElementById('profile-menu');
        const profilePic = document.getElementById('profile-pic');
        const profileIcon = document.getElementById('profile-icon');
        const loginSignupLink = document.getElementById('login-signup-link');
        const myProfileLink = document.getElementById('my-profile-link');
        const logoutButton = document.getElementById('logout-button');

        // Get form elements
        const postTitleInput = document.getElementById('post-title');
        const postAuthorInput = document.getElementById('post-author');
        const postCategorySelect = document.getElementById('post-category');
        const postContentTextarea = document.getElementById('post-content');
        const postImageUrlInput = document.getElementById('post-image-url');
        const blogPostForm = document.getElementById('blog-post-form');
        const publishButton = document.getElementById('publish-button');

        // Get error message elements
        const titleError = document.getElementById('title-error');
        const contentError = document.getElementById('content-error');
        const messageArea = document.getElementById('message-area');
        const firebaseStatusDiv = document.getElementById('firebase-status'); // New element

        // Get modal elements
        const authModal = document.getElementById('auth-modal');
        const goToAuthButton = document.getElementById('go-to-auth-button');

        // Custom message display function (replaces alert)
        function displayCustomMessage(message, type = 'success') {
            console.log(`UI Message (${type}): ${message}`); // Log to console
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Initialize Firebase on window load
        window.onload = () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    firebaseStatusDiv.textContent = 'Firebase berhasil diinisialisasi.';
                    firebaseStatusDiv.classList.remove('hidden');
                    firebaseStatusDiv.classList.remove('bg-red-50', 'text-red-800', 'border-red-200');
                    firebaseStatusDiv.classList.add('bg-blue-50', 'text-blue-800', 'border-blue-200');
                    console.log("Firebase app initialized on tulis-blog page:", app);
                    console.log("Firebase auth object on tulis-blog page:", auth);
                    console.log("Firestore DB object on tulis-blog page:", db);

                    // Listen for authentication state changes
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // User is signed in
                            currentUser = user;
                            console.log("Auth State Changed on tulis-blog page: User is logged in.", user.uid);
                            profileIcon.classList.add('hidden');
                            profilePic.classList.remove('hidden');
                            if (user.photoURL) {
                                profilePic.src = user.photoURL;
                            } else {
                                const initial = user.displayName ? user.displayName.charAt(0).toUpperCase() : (user.email ? user.email.charAt(0).toUpperCase() : 'U');
                                profilePic.src = `https://placehold.co/40x40/cbd5e1/4a5568?text=${initial}`;
                            }
                            loginSignupLink.classList.add('hidden');
                            myProfileLink.classList.remove('hidden');
                            logoutButton.classList.remove('hidden');

                            // Auto-fill author name if logged in
                            if (currentUser.displayName) {
                                postAuthorInput.value = currentUser.displayName;
                            } else if (currentUser.email) {
                                postAuthorInput.value = currentUser.email.split('@')[0]; // Use part of email if no display name
                            }
                            postAuthorInput.readOnly = true; // Make it read-only
                            postAuthorInput.classList.remove('border-gray-300', 'focus:ring-blue-500');
                            postAuthorInput.classList.add('bg-gray-100', 'cursor-not-allowed');

                            // Hide modal if user logs in while on this page
                            authModal.classList.add('hidden');
                            // Enable form fields
                            blogPostForm.querySelectorAll('input, textarea, select, button').forEach(element => {
                                element.disabled = false;
                            });

                        } else {
                            // User is signed out, show modal
                            console.log("Auth State Changed on tulis-blog page: User is logged out. Showing auth modal.");
                            authModal.classList.remove('hidden');
                            // Disable form fields when modal is active
                            blogPostForm.querySelectorAll('input, textarea, select, button').forEach(element => {
                                if (element.id !== 'go-to-auth-button') { // Don't disable the modal button itself
                                    element.disabled = true;
                                }
                            });
                            // Ensure publish button is disabled
                            publishButton.disabled = true;
                            publishButton.textContent = 'Login untuk Mempublikasikan';
                            publishButton.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    });

                } else {
                    firebaseStatusDiv.textContent = 'Firebase config tidak ditemukan. Fitur blog tidak akan berfungsi.';
                    firebaseStatusDiv.classList.remove('hidden');
                    firebaseStatusDiv.classList.remove('bg-blue-50', 'text-blue-800', 'border-blue-200');
                    firebaseStatusDiv.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                    console.error("Firebase config is empty or missing on tulis-blog page. Blog features will not work.");
                    // Ensure modal is shown and form is disabled if Firebase config is missing
                    authModal.classList.remove('hidden');
                    blogPostForm.querySelectorAll('input, textarea, select, button').forEach(element => {
                        if (element.id !== 'go-to-auth-button') {
                            element.disabled = true;
                        }
                    });
                    publishButton.disabled = true;
                    publishButton.textContent = 'Firebase Error';
                    publishButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                firebaseStatusDiv.textContent = `Error inisialisasi Firebase: ${error.message}`;
                firebaseStatusDiv.classList.remove('hidden');
                firebaseStatusDiv.classList.remove('bg-blue-50', 'text-blue-800', 'border-blue-200');
                firebaseStatusDiv.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                console.error("Error initializing Firebase on tulis-blog page:", error);
                displayCustomMessage(`Error inisialisasi Firebase: ${error.message}`, 'error');
                // Ensure modal is shown and form is disabled on init error
                authModal.classList.remove('hidden');
                blogPostForm.querySelectorAll('input, textarea, select, button').forEach(element => {
                    if (element.id !== 'go-to-auth-button') {
                        element.disabled = true;
                    }
                });
                publishButton.disabled = true;
                publishButton.textContent = 'Firebase Error';
                publishButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        };

        // Toggle profile menu visibility
        profileMenuButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent click from bubbling to window
            profileMenu.classList.toggle('hidden');
        });

        // Close menu if clicked outside
        window.addEventListener('click', (event) => {
            if (!profileMenuButton.contains(event.target) && !profileMenu.contains(event.target)) {
                profileMenu.classList.add('hidden');
            }
        });

        // Handle logout
        logoutButton.addEventListener('click', async () => {
            if (!auth) {
                displayCustomMessage('Firebase Auth belum diinisialisasi.', 'error');
                console.error('Logout failed: Firebase Auth not initialized.');
                return;
            }
            try {
                await signOut(auth);
                console.log("User logged out successfully from tulis-blog page.");
                window.location.href = 'homepage-template.html'; // Redirect to homepage after logout
            } catch (error) {
                console.error("Logout Error on tulis-blog page:", error);
                displayCustomMessage('Terjadi kesalahan saat logout. Coba lagi.', 'error');
            }
        });

        // Handle form submission
        blogPostForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission

            // Reset error messages
            titleError.classList.add('hidden');
            contentError.classList.add('hidden');
            messageArea.innerHTML = ''; // Clear general messages

            let isValid = true;

            // Form Validation
            if (postTitleInput.value.trim() === '') {
                titleError.classList.remove('hidden');
                isValid = false;
            }
            if (postContentTextarea.value.trim() === '') {
                contentError.classList.remove('hidden');
                isValid = false;
            }

            if (!isValid) {
                displayCustomMessage('Mohon lengkapi semua kolom yang wajib diisi.', 'error');
                console.warn("Form validation failed: Title or content is empty.");
                return; // Stop if validation fails
            }

            if (!currentUser) {
                displayCustomMessage('Anda harus login untuk mempublikasikan postingan.', 'error');
                authModal.classList.remove('hidden'); // Ensure modal is shown
                console.error("Attempted to publish without a logged-in user.");
                return;
            }
            if (!db) {
                displayCustomMessage('Firestore DB belum diinisialisasi. Tidak dapat mempublikasikan.', 'error');
                console.error("Firestore DB not initialized. Cannot publish post.");
                return;
            }


            // Prepare post data
            const postData = {
                title: postTitleInput.value.trim(),
                author: postAuthorInput.value.trim() || (currentUser.displayName || currentUser.email.split('@')[0]), // Fallback author name
                category: postCategorySelect.value || 'lain-lain', // Default to 'lain-lain' if category is empty
                content: postContentTextarea.value.trim(),
                imageUrl: postImageUrlInput.value.trim() || 'https://placehold.co/400x250/cccccc/333333?text=Default+Image', // Default image
                createdAt: serverTimestamp(), // Firestore timestamp
                userId: currentUser.uid // Store the user ID
            };
            console.log("Attempting to publish post with data:", postData);

            // Disable button and show loading
            publishButton.disabled = true;
            publishButton.textContent = 'Mempublikasikan...';
            publishButton.classList.add('opacity-50', 'cursor-not-allowed');

            // Save data to Firestore
            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/blogPosts`), postData);
                console.log("Document written with ID: ", docRef.id);
                displayCustomMessage('Postingan Anda berhasil diterbitkan!');

                // Clear the form
                postTitleInput.value = '';
                postAuthorInput.value = currentUser.displayName || currentUser.email.split('@')[0]; // Re-fill author
                postCategorySelect.value = '';
                postContentTextarea.value = '';
                postImageUrlInput.value = '';

            } catch (e) {
                console.error("Error adding document: ", e);
                displayCustomMessage('Terjadi kesalahan saat menerbitkan postingan. Coba lagi.', 'error');
            } finally {
                // Re-enable button
                publishButton.disabled = false;
                publishButton.textContent = 'Publikasikan Postingan';
                publishButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Handle click on "Login / Daftar Sekarang" button in the modal
        goToAuthButton.addEventListener('click', () => {
            console.log("Redirecting to auth-page.html from modal.");
            window.location.href = 'auth-page.html';
        });
    </script>
</body>
</html>
