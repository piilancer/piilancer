<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baca Blog - Piilancer: Ruang Kreasi Pelajar</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Pacifico (for logo) and Montserrat (for headings) -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom font for a modern look */
        body {
            font-family: "Inter", sans-serif;
        }
        /* Custom blue color for Tailwind */
        .bg-custom-blue {
            background-color: #8aceff;
        }
        .text-custom-blue {
            color: #8aceff;
        }
        .hover\\:bg-custom-blue-light:hover {
            background-color: #e0f2ff; /* A lighter shade for hover effects */
        }
        .hover\\:text-custom-blue-dark:hover {
            color: #007bff; /* A slightly darker blue for hover text */
        }
        .focus\\:ring-custom-blue-focus:focus {
            --tw-ring-color: #8aceff;
        }
        /* Style for Piilancer logo font */
        .piilancer-logo {
            font-family: 'Pacifico', cursive;
            font-size: 2rem; /* Reduced from 2.5rem */
            line-height: 1;
        }
        /* Style for Hero Section Heading font */
        .hero-heading-font {
            font-family: 'Montserrat', sans-serif;
        }

        /* CSS for Blog Post Card Hover Effect */
        .blog-post-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .blog-post-card:hover {
            transform: translateY(-8px); /* Lift effect */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Stronger shadow */
            border-color: #3b82f6; /* Blue border on hover */
        }
        .blog-post-card:hover .blog-post-image {
            transform: scale(1.05); /* Slightly scale image on hover */
        }
        .blog-post-card:hover .blog-post-title {
            color: #007bff; /* Darker blue for title on hover */
        }
        .blog-post-card:hover .blog-read-more-arrow {
            transform: translateX(4px); /* Move arrow on hover */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
    <div class="min-h-screen flex flex-col">
        <!-- Header Section (Consistent with Homepage) -->
        <header class="bg-white shadow-md py-4">
            <div class="container mx-auto px-4 flex justify-between items-center">
                <a href="homepage-template.html" class="piilancer-logo text-blue-600 rounded-lg p-2 hover:bg-blue-50 transition duration-300">Piilancer</a>
                <nav class="hidden md:flex space-x-6 items-center">
                    <a href="baca-blog-page.html" class="text-blue-600 font-bold transition duration-300 rounded-lg px-3 py-2 bg-gray-100">Baca Blog</a>
                    <a href="tulis-blog-page.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300 rounded-lg px-3 py-2 hover:bg-gray-100">Tulis Blog</a>
                    <a href="kedai-pelajar-page.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300 rounded-lg px-3 py-2 hover:bg-gray-100">Kedai Pelajar</a>
                    <a href="tentang-page.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300 rounded-lg px-3 py-2 hover:bg-gray-100">Tentang</a>

                    <!-- Profile Picture / Auth Menu -->
                    <div class="relative ml-4">
                        <button id="profile-menu-button" class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-200 text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                            <img id="profile-pic" src="https://placehold.co/40x40/cbd5e1/4a5568?text=U" alt="User Profile" class="rounded-full w-full h-full object-cover hidden">
                            <svg id="profile-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M12 4a4 4 0 100 8 4 4 0 000-8zm-2 9a4 4 0 00-4 4v1a2 2 0 002 2h8a2 2 0 002-2v-1a4 4 0 00-4-4h-4z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="profile-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                            <a href="auth-page.html" id="login-signup-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Login / Daftar</a>
                            <a href="#" id="my-profile-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hidden">Profil Saya</a>
                            <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 hidden">Logout</button>
                        </div>
                    </div>
                </nav>
                <!-- Mobile Menu Button (Hamburger) -->
                <button class="md:hidden text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content - Blog Listing -->
        <main class="flex-grow py-16 bg-gray-100">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-12 text-gray-900 hero-heading-font">Semua Postingan Blog</h1>

                <!-- Search and Filter (Simple Example) -->
                <div class="mb-10 flex flex-col md:flex-row justify-between items-center gap-4">
                    <input type="text" placeholder="Cari postingan..." class="w-full md:w-1/3 p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    <select class="w-full md:w-1/4 p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-white">
                        <option value="">Filter Kategori</option>
                        <option value="pendidikan">Pendidikan</option>
                        <option value="kreativitas">Kreativitas</option>
                        <option value="inspirasi">Inspirasi</option>
                        <option value="tips">Tips & Trik</option>
                    </select>
                </div>

                <!-- Blog Posts Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="blog-posts-grid">
                    <!-- Status message for Firebase/loading -->
                    <p class="col-span-full text-center text-gray-600" id="firebase-status">Memuat Firebase...</p>
                    <p class="col-span-full text-center text-gray-600" id="loading-message">Memuat postingan...</p>
                </div>

                <!-- Load More Button / Pagination -->
                <div class="text-center mt-12">
                    <button id="load-more-button" class="bg-blue-600 text-white hover:bg-blue-700 px-8 py-4 rounded-full font-semibold shadow-xl transition duration-300 transform hover:scale-105">
                        Muat Postingan Lainnya
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer Section (Consistent with Homepage) -->
        <footer class="bg-gray-800 text-white py-8">
            <div class="container mx-auto px-4 text-center">
                <p class="text-gray-400">&copy; 2025 Piilancer. All rights reserved.</p>
                <div class="flex justify-center space-x-6 mt-4">
                    <a href="https://instagram.com/piilancer" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition duration-300 rounded-lg p-2 hover:bg-gray-700 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2.411a.75.75 0 01.597.953l-1.39 4.364 7.26 2.253a.75.75 0 01.385 1.487l-7.26 2.253 1.39 4.364a.75.75 0 01-1.35.43l-1.39-4.364-7.26 2.253a.75.75 0 01-.385-1.487l7.26-2.253-1.39-4.364a.75.75 0 01.75-.43zM12 0a12 12 0 100 24 12 12 0 000-24z" clip-rule="evenodd" />
                        </svg>
                        <span>@piilancer</span>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition duration-300 rounded-lg p-2 hover:bg-gray-700">Kebijakan Privasi</a>
                    <a href="#" class="text-gray-400 hover:text-white transition duration-300 rounded-lg p-2 hover:bg-gray-700">Ketentuan Layanan</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, limit, getDocs, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- START LOCAL DEVELOPMENT CONFIG (UNCOMMENT AND FILL FOR LOCAL TESTING) ---
        /*
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            // measurementId: "YOUR_MEASUREMENT_ID" // Optional
        };
        const appId = "YOUR_PROJECT_ID"; // Or any unique ID for your local testing
        */
        // --- END LOCAL DEVELOPMENT CONFIG ---

        // Firebase configuration (provided by Canvas environment, or use local config above)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fallback for local testing

        let app;
        let auth;
        let db;

        // Get elements for header profile menu
        const profileMenuButton = document.getElementById('profile-menu-button');
        const profileMenu = document.getElementById('profile-menu');
        const profilePic = document.getElementById('profile-pic');
        const profileIcon = document.getElementById('profile-icon');
        const loginSignupLink = document.getElementById('login-signup-link');
        const myProfileLink = document.getElementById('my-profile-link');
        const logoutButton = document.getElementById('logout-button');

        // Blog listing specific elements
        const blogPostsGrid = document.getElementById('blog-posts-grid');
        const loadMoreButton = document.getElementById('load-more-button');
        const loadingMessage = document.getElementById('loading-message');
        const firebaseStatusDiv = document.getElementById('firebase-status');
        let lastVisible = null; // For pagination
        const postsPerPage = 6; // Number of posts to load per click

        // Custom message display function (replaces alert)
        function displayCustomMessage(message, type = 'success') {
            console.log(`UI Message (${type}): ${message}`); // Log to console
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Initialize Firebase on window load
        window.onload = () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    firebaseStatusDiv.textContent = 'Firebase berhasil diinisialisasi.';
                    firebaseStatusDiv.classList.remove('hidden');
                    firebaseStatusDiv.classList.remove('bg-red-50', 'text-red-800', 'border-red-200');
                    firebaseStatusDiv.classList.add('bg-blue-50', 'text-blue-800', 'border-blue-200');
                    console.log("Firebase app initialized on blog page:", app);
                    console.log("Firebase auth object on blog page:", auth);
                    console.log("Firestore DB object on blog page:", db);

                    // Listen for auth state changes for header profile menu
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            console.log("Auth State Changed on blog page: User is logged in.", user.uid);
                            profileIcon.classList.add('hidden');
                            profilePic.classList.remove('hidden');
                            if (user.photoURL) {
                                profilePic.src = user.photoURL;
                            } else {
                                const initial = user.displayName ? user.displayName.charAt(0).toUpperCase() : (user.email ? user.email.charAt(0).toUpperCase() : 'U');
                                profilePic.src = `https://placehold.co/40x40/cbd5e1/4a5568?text=${initial}`;
                            }
                            loginSignupLink.classList.add('hidden');
                            myProfileLink.classList.remove('hidden');
                            logoutButton.classList.remove('hidden');
                        } else {
                            console.log("Auth State Changed on blog page: User is logged out.");
                            profileIcon.classList.remove('hidden');
                            profilePic.classList.add('hidden');
                            loginSignupLink.classList.remove('hidden');
                            myProfileLink.classList.add('hidden');
                            logoutButton.classList.add('hidden');
                        }
                    });

                    // Fetch blog posts after Firebase is initialized
                    fetchBlogPosts();

                } else {
                    firebaseStatusDiv.textContent = 'Firebase config tidak ditemukan. Fitur blog tidak akan berfungsi.';
                    firebaseStatusDiv.classList.remove('hidden');
                    firebaseStatusDiv.classList.remove('bg-blue-50', 'text-blue-800', 'border-blue-200');
                    firebaseStatusDiv.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                    console.error("Firebase config is empty or missing on blog page. Blog features will not work.");
                    loadingMessage.textContent = 'Gagal memuat postingan: Konfigurasi Firebase tidak ditemukan.';
                    loadMoreButton.classList.add('hidden');
                }
            } catch (error) {
                firebaseStatusDiv.textContent = `Error inisialisasi Firebase: ${error.message}`;
                firebaseStatusDiv.classList.remove('hidden');
                firebaseStatusDiv.classList.remove('bg-blue-50', 'text-blue-800', 'border-blue-200');
                firebaseStatusDiv.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                console.error("Error initializing Firebase on blog page:", error);
                displayCustomMessage(`Error inisialisasi Firebase: ${error.message}`, 'error');
                loadingMessage.textContent = 'Gagal memuat postingan karena kesalahan inisialisasi Firebase.';
                loadMoreButton.classList.add('hidden');
            }
        };

        // Toggle profile menu visibility
        profileMenuButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent click from bubbling to window
            profileMenu.classList.toggle('hidden');
        });

        // Close menu if clicked outside
        window.addEventListener('click', (event) => {
            if (!profileMenuButton.contains(event.target) && !profileMenu.contains(event.target)) {
                profileMenu.classList.add('hidden');
            }
        });

        // Handle logout
        logoutButton.addEventListener('click', async () => {
            if (!auth) {
                displayCustomMessage('Firebase Auth belum diinisialisasi.', 'error');
                console.error('Logout failed: Firebase Auth not initialized.');
                return;
            }
            try {
                await signOut(auth);
                console.log("User logged out successfully from blog page.");
                window.location.reload(); // Simple reload to reflect auth state
            } catch (error) {
                console.error("Logout Error on blog page:", error);
                displayCustomMessage('Terjadi kesalahan saat logout. Coba lagi.', 'error');
            }
        });

        async function fetchBlogPosts() {
            if (!db) {
                console.error("Firestore DB not initialized. Cannot fetch blog posts.");
                loadingMessage.textContent = 'Gagal memuat postingan: Firestore tidak diinisialisasi.';
                return;
            }

            loadingMessage.classList.remove('hidden');
            loadMoreButton.disabled = true;
            loadMoreButton.classList.add('opacity-50', 'cursor-not-allowed');
            console.log("Attempting to fetch blog posts...");

            let q;
            // IMPORTANT: Avoid using orderBy() in Firestore queries, as it can lead to runtime errors like index missing.
            // If you need to sort data, fetch all the data and sort it in memory using javascript.
            // For simplicity and to avoid index issues in this example, we'll fetch without orderBy for now.
            // In a real app, you'd set up Firestore indexes for 'createdAt' field.
            const blogPostsCollectionRef = collection(db, `artifacts/${appId}/public/data/blogPosts`);

            if (lastVisible) {
                q = query(blogPostsCollectionRef, limit(postsPerPage), startAfter(lastVisible));
                console.log("Fetching more posts starting after:", lastVisible.id);
            } else {
                q = query(blogPostsCollectionRef, limit(postsPerPage));
                console.log("Fetching initial posts.");
            }

            try {
                const documentSnapshots = await getDocs(q);
                loadingMessage.classList.add('hidden');
                loadMoreButton.disabled = false;
                loadMoreButton.classList.remove('opacity-50', 'cursor-not-allowed');
                console.log(`Fetched ${documentSnapshots.docs.length} documents.`);

                if (documentSnapshots.empty && !lastVisible) {
                    blogPostsGrid.innerHTML = '<p class="col-span-full text-center text-gray-600">Belum ada postingan blog.</p>';
                    loadMoreButton.classList.add('hidden');
                    console.log("No blog posts found.");
                    return;
                }

                // Append new posts
                documentSnapshots.forEach((doc) => {
                    const post = doc.data();
                    // Sort by createdAt client-side if needed, as orderBy is removed for simplicity
                    const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString('id-ID') : 'Tanggal tidak diketahui';
                    const imageUrl = post.imageUrl || 'https://placehold.co/400x250/cccccc/333333?text=Default+Image';

                    const postCardHtml = `
                        <div class="blog-post-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 relative overflow-hidden">
                            <img src="${imageUrl}" alt="${post.title}" class="rounded-lg mb-4 w-full h-48 object-cover blog-post-image transition duration-300" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/333333?text=Default+Image';">
                            <h3 class="text-xl font-semibold text-blue-700 mb-2 blog-post-title transition duration-300">${post.title}</h3>
                            <p class="text-gray-600 text-sm mb-3">Oleh: ${post.author || 'Anonim'} | ${date}</p>
                            <p class="text-gray-700 mb-4 line-clamp-4">
                                ${post.content}
                            </p>
                            <a href="#" class="text-blue-600 hover:text-blue-800 font-medium flex items-center space-x-1">
                                <span>Baca Selengkapnya</span>
                                <svg class="w-4 h-4 blog-read-more-arrow transition duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                            </a>
                        </div>
                    `;
                    blogPostsGrid.insertAdjacentHTML('beforeend', postCardHtml);
                });

                lastVisible = documentSnapshots.docs[documentSnapshots.docs.length - 1];

                if (documentSnapshots.docs.length < postsPerPage) {
                    loadMoreButton.classList.add('hidden');
                    console.log("All posts loaded.");
                } else {
                    loadMoreButton.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Error fetching blog posts:", error);
                loadingMessage.textContent = 'Gagal memuat postingan. Coba lagi nanti.';
                loadMoreButton.classList.add('hidden');
                displayCustomMessage(`Error memuat postingan: ${error.message}`, 'error');
            }
        }

        // Load more button click
        loadMoreButton.addEventListener('click', fetchBlogPosts);
    </script>
</body>
</html>
